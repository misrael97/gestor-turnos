<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>Reportes Globales</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ion-refresher slot="fixed" (ionRefresh)="cargarReportes($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <ion-grid class="ion-padding">
    <!-- Spinner de carga -->
    <ion-grid *ngIf="loading" class="ion-text-center ion-padding">
      <ion-spinner name="crescent"></ion-spinner>
      <ion-text><ion-label>Cargando reportes...</ion-label></ion-text>
    </ion-grid>

    <!-- Contenido principal -->
    <ion-grid *ngIf="!loading">
      <!-- Cards de estadísticas principales -->
      <ion-grid>
        <ion-row>
          <ion-col size="12" size-md="6">
            <ion-card color="primary">
              <ion-card-content class="ion-text-center">
                <ion-icon name="business-outline" style="font-size: 48px;"></ion-icon>
                <ion-text class="ion-no-margin"><ion-label>{{ reportes.negociosActivos || reportes.total_sucursales || 0 }}</ion-label></ion-text>
                <ion-text class="ion-no-margin"><ion-label>Negocios/Sucursales</ion-label></ion-text>
              </ion-card-content>
            </ion-card>
          </ion-col>
          <ion-col size="12" size-md="6">
            <ion-card color="success">
              <ion-card-content class="ion-text-center">
                <ion-icon name="people-outline" style="font-size: 48px;"></ion-icon>
                <ion-text class="ion-no-margin"><ion-label>{{ reportes.usuariosActivos || reportes.total_usuarios || 0 }}</ion-label></ion-text>
                <ion-text class="ion-no-margin"><ion-label>Usuarios Activos</ion-label></ion-text>
              </ion-card-content>
            </ion-card>
          </ion-col>
        </ion-row>

        <ion-row>
          <ion-col size="12" size-md="6">
            <ion-card color="tertiary">
              <ion-card-content class="ion-text-center">
                <ion-icon name="calendar-outline" style="font-size: 48px;"></ion-icon>
                <ion-text class="ion-no-margin"><ion-label>{{ reportes.turnosHoy || 0 }}</ion-label></ion-text>
                <ion-text class="ion-no-margin"><ion-label>Turnos Hoy</ion-label></ion-text>
              </ion-card-content>
            </ion-card>
          </ion-col>
          <ion-col size="12" size-md="6">
            <ion-card color="warning">
              <ion-card-content class="ion-text-center">
                <ion-icon name="checkmark-done-outline" style="font-size: 48px;"></ion-icon>
                <ion-text class="ion-no-margin"><ion-label>{{ reportes.totalTurnos || reportes.total_turnos || 0 }}</ion-label></ion-text>
                <ion-text class="ion-no-margin"><ion-label>Turnos Totales</ion-label></ion-text>
              </ion-card-content>
            </ion-card>
          </ion-col>
        </ion-row>

        <ion-row>
          <ion-col size="12" size-md="6">
            <ion-card color="medium">
              <ion-card-content class="ion-text-center">
                <ion-icon name="hourglass-outline" style="font-size: 48px;"></ion-icon>
                <ion-text class="ion-no-margin"><ion-label>{{ reportes.turnosPendientes || 0 }}</ion-label></ion-text>
                <ion-text class="ion-no-margin"><ion-label>Pendientes</ion-label></ion-text>
              </ion-card-content>
            </ion-card>
          </ion-col>
          <ion-col size="12" size-md="6">
            <ion-card color="success">
              <ion-card-content class="ion-text-center">
                <ion-icon name="checkmark-circle-outline" style="font-size: 48px;"></ion-icon>
                <ion-text class="ion-no-margin"><ion-label>{{ reportes.turnosAtendidos || 0 }}</ion-label></ion-text>
                <ion-text class="ion-no-margin"><ion-label>Atendidos</ion-label></ion-text>
              </ion-card-content>
            </ion-card>
          </ion-col>
        </ion-row>
      </ion-grid>

      <!-- Resumen detallado -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>Resumen del Sistema</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-list>
            <ion-item>
              <ion-icon name="timer-outline" slot="start" color="primary"></ion-icon>
              <ion-label>
                <ion-text><ion-label>Tiempo Promedio de Espera</ion-label></ion-text>
                <ion-text><ion-label>{{ reportes.promedio_espera || 0 }} minutos</ion-label></ion-text>
              </ion-label>
            </ion-item>
            <ion-item>
              <ion-icon name="trending-up-outline" slot="start" color="success"></ion-icon>
              <ion-label>
                <ion-text><ion-label>Eficiencia del Sistema</ion-label></ion-text>
                <ion-text><ion-label>{{ reportes.eficiencia || 'N/A' }}</ion-label></ion-text>
              </ion-label>
            </ion-item>
            <ion-item>
              <ion-icon name="calendar-number-outline" slot="start" color="tertiary"></ion-icon>
              <ion-label>
                <ion-text><ion-label>Última Actualización</ion-label></ion-text>
                <ion-text><ion-label>{{ reportes.ultima_actualizacion || 'Ahora' }}</ion-label></ion-text>
              </ion-label>
            </ion-item>
          </ion-list>
        </ion-card-content>
      </ion-card>

      <!-- Top Sucursales (si el backend lo provee) -->
      <ion-card *ngIf="reportes.top_sucursales && reportes.top_sucursales.length > 0">
        <ion-card-header>
          <ion-card-title>Top Sucursales por Productividad</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-list>
            <ion-item *ngFor="let s of reportes.top_sucursales; let i = index">
              <ion-badge slot="start" [color]="i === 0 ? 'warning' : i === 1 ? 'medium' : 'tertiary'">
                {{ i + 1 }}
              </ion-badge>
              <ion-label>
                <ion-text><ion-label>{{ s.nombre }}</ion-label></ion-text>
                <ion-text><ion-label>{{ s.turnos_atendidos }} turnos atendidos</ion-label></ion-text>
              </ion-label>
              <ion-badge color="success">{{ s.productividad }}%</ion-badge>
            </ion-item>
          </ion-list>
        </ion-card-content>
      </ion-card>

      <!-- Mensaje de advertencia si hay error -->
      <ion-card *ngIf="error" color="warning">
        <ion-card-content class="ion-text-center">
          <ion-icon name="alert-circle-outline" style="font-size: 64px;"></ion-icon>
          <ion-text><ion-label>Endpoint no disponible</ion-label></ion-text>
          <ion-text><ion-label>El endpoint /api/reportes-globales no está implementado en el backend.</ion-label></ion-text>
          <ion-text class="ion-text-muted"><ion-label>Los datos mostrados son valores de ejemplo para desarrollo.</ion-label></ion-text>
        </ion-card-content>
      </ion-card>
    </ion-grid>
  </ion-grid>
</ion-content>
