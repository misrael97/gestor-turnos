<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>Reportes Globales</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ion-refresher slot="fixed" (ionRefresh)="cargarReportes($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="ion-padding">
    <!-- Spinner de carga -->
    <div *ngIf="loading" class="ion-text-center ion-padding">
      <ion-spinner name="crescent"></ion-spinner>
      <p>Cargando reportes...</p>
    </div>

    <!-- Contenido principal -->
    <div *ngIf="!loading">
      <!-- Cards de estadísticas principales -->
      <ion-grid>
        <ion-row>
          <ion-col size="12" size-md="6">
            <ion-card color="primary">
              <ion-card-content class="ion-text-center">
                <ion-icon name="business-outline" style="font-size: 48px;"></ion-icon>
                <h1 class="ion-no-margin">{{ reportes.negociosActivos || reportes.total_sucursales || 0 }}</h1>
                <p class="ion-no-margin">Negocios/Sucursales</p>
              </ion-card-content>
            </ion-card>
          </ion-col>
          <ion-col size="12" size-md="6">
            <ion-card color="success">
              <ion-card-content class="ion-text-center">
                <ion-icon name="people-outline" style="font-size: 48px;"></ion-icon>
                <h1 class="ion-no-margin">{{ reportes.usuariosActivos || reportes.total_usuarios || 0 }}</h1>
                <p class="ion-no-margin">Usuarios Activos</p>
              </ion-card-content>
            </ion-card>
          </ion-col>
        </ion-row>

        <ion-row>
          <ion-col size="12" size-md="6">
            <ion-card color="tertiary">
              <ion-card-content class="ion-text-center">
                <ion-icon name="calendar-outline" style="font-size: 48px;"></ion-icon>
                <h1 class="ion-no-margin">{{ reportes.turnosHoy || 0 }}</h1>
                <p class="ion-no-margin">Turnos Hoy</p>
              </ion-card-content>
            </ion-card>
          </ion-col>
          <ion-col size="12" size-md="6">
            <ion-card color="warning">
              <ion-card-content class="ion-text-center">
                <ion-icon name="checkmark-done-outline" style="font-size: 48px;"></ion-icon>
                <h1 class="ion-no-margin">{{ reportes.totalTurnos || reportes.total_turnos || 0 }}</h1>
                <p class="ion-no-margin">Turnos Totales</p>
              </ion-card-content>
            </ion-card>
          </ion-col>
        </ion-row>

        <ion-row>
          <ion-col size="12" size-md="6">
            <ion-card color="medium">
              <ion-card-content class="ion-text-center">
                <ion-icon name="hourglass-outline" style="font-size: 48px;"></ion-icon>
                <h1 class="ion-no-margin">{{ reportes.turnosPendientes || 0 }}</h1>
                <p class="ion-no-margin">Pendientes</p>
              </ion-card-content>
            </ion-card>
          </ion-col>
          <ion-col size="12" size-md="6">
            <ion-card color="success">
              <ion-card-content class="ion-text-center">
                <ion-icon name="checkmark-circle-outline" style="font-size: 48px;"></ion-icon>
                <h1 class="ion-no-margin">{{ reportes.turnosAtendidos || 0 }}</h1>
                <p class="ion-no-margin">Atendidos</p>
              </ion-card-content>
            </ion-card>
          </ion-col>
        </ion-row>
      </ion-grid>

      <!-- Resumen detallado -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>Resumen del Sistema</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-list>
            <ion-item>
              <ion-icon name="timer-outline" slot="start" color="primary"></ion-icon>
              <ion-label>
                <h3>Tiempo Promedio de Espera</h3>
                <p>{{ reportes.promedio_espera || 0 }} minutos</p>
              </ion-label>
            </ion-item>
            <ion-item>
              <ion-icon name="trending-up-outline" slot="start" color="success"></ion-icon>
              <ion-label>
                <h3>Eficiencia del Sistema</h3>
                <p>{{ reportes.eficiencia || 'N/A' }}</p>
              </ion-label>
            </ion-item>
            <ion-item>
              <ion-icon name="calendar-number-outline" slot="start" color="tertiary"></ion-icon>
              <ion-label>
                <h3>Última Actualización</h3>
                <p>{{ reportes.ultima_actualizacion || 'Ahora' }}</p>
              </ion-label>
            </ion-item>
          </ion-list>
        </ion-card-content>
      </ion-card>

      <!-- Top Sucursales (si el backend lo provee) -->
      <ion-card *ngIf="reportes.top_sucursales && reportes.top_sucursales.length > 0">
        <ion-card-header>
          <ion-card-title>Top Sucursales por Productividad</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-list>
            <ion-item *ngFor="let s of reportes.top_sucursales; let i = index">
              <ion-badge slot="start" [color]="i === 0 ? 'warning' : i === 1 ? 'medium' : 'tertiary'">
                {{ i + 1 }}
              </ion-badge>
              <ion-label>
                <h2>{{ s.nombre }}</h2>
                <p>{{ s.turnos_atendidos }} turnos atendidos</p>
              </ion-label>
              <ion-badge color="success">{{ s.productividad }}%</ion-badge>
            </ion-item>
          </ion-list>
        </ion-card-content>
      </ion-card>

      <!-- Mensaje de advertencia si hay error -->
      <ion-card *ngIf="error" color="warning">
        <ion-card-content class="ion-text-center">
          <ion-icon name="alert-circle-outline" style="font-size: 64px;"></ion-icon>
          <h2>Endpoint no disponible</h2>
          <p>El endpoint /api/reportes-globales no está implementado en el backend.</p>
          <p class="ion-text-muted">Los datos mostrados son valores de ejemplo para desarrollo.</p>
        </ion-card-content>
      </ion-card>
    </div>
  </div>
</ion-content>
